<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì´ì•¼ê¸° ìŠ¤íŠœë””ì˜¤ v1.1</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* ğŸ”¥ CDNì„ í†µí•œ ë¦¬ë””ë°”íƒ• í°íŠ¸ ì •ì˜ */
        @font-face {
            font-family: 'Ridibatang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/RIDIBatang.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }

        /* --- CSS Variables --- */
        :root {
            --bg-app: #F4F4F5; --bg-sidebar: #FFFFFF; --bg-paper: #FFFFFF; --bg-modal: #FFFFFF;
            --text-main: #18181B; --text-mute: #71717A; --accent: #3B82F6; --accent-bg: #EFF6FF;
            --border: #E4E4E7; --sidebar-width: 260px; --postit-bg: #FEF3C7; --postit-text: #78350F;
            --postit-border: #FCD34D;
            --alert-success: #10B981;
            --alert-error: #EF4444;
            /* ğŸ”¥ í™œì„±í™” ìƒ‰ìƒ ì •ì˜ (íšŒìƒ‰ í†µì¼) */
            --active-color: #3F3F46; /* ZINC-700 / ì§™ì€ íšŒìƒ‰ */
            --active-bg: #E5E7EB; /* GRAY-200 / ë°ì€ íšŒìƒ‰ */
        }

        :root[data-theme="dark"] {
            --bg-app: #09090B; --bg-sidebar: #18181B; --bg-paper: #18181B; --bg-modal: #18181B;
            --text-main: #FAFAFA; --text-mute: #A1A1AA; --accent: #60A5FA; --accent-bg: #27272A;
            --border: #27272A; --postit-bg: #422006; --postit-text: #FEF3C7; --postit-border: #78350F;
            /* ğŸ”¥ ë‹¤í¬ ëª¨ë“œì—ì„œì˜ í™œì„±í™” ìƒ‰ìƒ ì •ì˜ */
            --active-color: #FAFAFA; /* WHITE / í°ìƒ‰ í…ìŠ¤íŠ¸ */
            --active-bg: #3F3F46; /* ZINC-700 / ì§™ì€ íšŒìƒ‰ */
        }

        /* --- Global Reset and Base --- */
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body {
            /* ê¸°ë³¸ í°íŠ¸: ì‹œìŠ¤í…œ ê¸°ë³¸(sans-serif) */
            font-family: sans-serif;
            background-color: var(--bg-app); 
            color: var(--text-main); height: 100vh; overflow: hidden; font-size: 14px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Ridibatang í°íŠ¸ í™œì„±í™” í´ë˜ìŠ¤ (CDN í°íŠ¸ ì‚¬ìš©) */
        body.custom-font-active {
            font-family: 'Ridibatang', sans-serif !important;
        }
        
        /* input, textareaì— í°íŠ¸ ìƒì† */
        input, textarea, button {
            font-family: inherit;
        }

        #app { display: flex; width: 100%; height: 100%; }

        /* --- Project Manager View Styles --- */
        .project-manager {
            width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center;
            padding: 40px 20px; overflow-y: auto;
        }
        .project-header {
            width: 100%; max-width: 800px; display: flex; flex-direction: column; 
            margin-bottom: 24px; padding-bottom: 12px; border-bottom: 2px solid var(--border);
        }
        .project-header-top {
             width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ì˜ ìˆ˜ì§ ì¤‘ì‹¬ì„ ë§ì¶”ê¸° ìœ„í•´ h2ì— display: flex ì ìš© */
        .project-header-top h2 {
            display: flex;
            align-items: center;
        }
        
        .global-actions {
            display: flex; gap: 8px; align-items: center; justify-content: flex-end; 
            width: 80%;
        }
        
        /* ì‹¬í”Œ ì•„ì´ì½˜ ë²„íŠ¼ (ê´€ë¦¬ì ëª©ë¡) */
        .global-action-icon {
            background: none; border: none; 
            color: var(--text-mute); cursor: pointer; border-radius: 6px;
            width: 36px; height: 36px; padding: 0;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .global-action-icon:hover {
            background: var(--accent-bg); color: var(--accent);
        }
        
        .global-btn {
            background: var(--bg-paper); border: 1px solid var(--border);
            color: var(--text-main); 
            padding: 8px 12px; font-weight: 600; cursor: pointer; border-radius: 6px;
            transition: 0.2s; display: flex; align-items: center; gap: 6px;
            white-space: nowrap;
        }
        .global-btn:hover {
            background: var(--accent-bg); color: var(--accent); border-color: var(--accent);
        }
        
        .project-list {
            width: 100%; max-width: 800px; list-style: none;
            background: var(--bg-paper);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .project-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; border-bottom: 1px solid var(--border);
            cursor: default; 
            transition: background-color 0.2s;
        }
        .project-item:last-child { border-bottom: none; }
        .project-item:hover { background: var(--accent-bg); }
        
        /* í”„ë¡œì íŠ¸ ì´ë¦„/ì •ë³´ë¥¼ í•œ ì¤„ë¡œ */
        .project-item-info { 
            flex: 1; 
            cursor: pointer; 
            display: flex; 
            align-items: baseline; 
            gap: 12px; 
        } 
        .project-item-info:hover { color: var(--accent); } 
        
        .project-item-title { 
            font-size: 16px; 
            font-weight: 700; 
            color: var(--text-main); 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%; 
        } 
        .project-item:hover .project-item-title { color: var(--text-main); } 
        
        .project-item-input { 
            width: 100%; background: var(--bg-app); border: 1px solid var(--accent); color: var(--text-main); padding: 4px 6px; font-size: 16px; font-family: inherit; font-weight: 700; 
        }
        
        /* ë‚ ì§œ ì •ë³´ë¥¼ ì‘ê³  ì–‡ê²Œ, í•œ ì¤„ì— ë°°ì¹˜ */
        .project-item-date { 
            font-size: 12px; 
            color: var(--text-mute); 
            font-weight: 400;
            flex-shrink: 0; 
        }
        .project-actions { display: flex; gap: 8px; flex-shrink: 0; }
        
        /* --- Sidebar & Toolbar --- */
        aside { 
            width: var(--sidebar-width); 
            background: var(--bg-sidebar); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            transition: width 0.3s ease, min-width 0.3s ease; 
            overflow: hidden; 
            white-space: nowrap; 
            z-index: 50; 
        }
        aside.closed { width: 0 !important; min-width: 0 !important; border: none; }
        
        .side-head { 
            height: 50px; 
            padding: 0 16px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-bottom: 1px solid var(--border); 
            font-weight: 700; 
        }
        .side-head span {
            flex-shrink: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .tree-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px 0; 
        }
        
        /* í”„ë¡œì íŠ¸ ê´€ë¦¬ì í˜ì´ì§€ í‘¸í„° ìŠ¤íƒ€ì¼ (ë²„ì „ ì •ë³´ìš©) */
        .manager-footer { 
            /* ìˆ˜ì •ëœ ìŠ¤íƒ€ì¼ ì ìš© */
            margin-top: auto; 
            margin-bottom: 0px; 
            width: 100%; 
            max-width: 800px; 
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-mute);
            background: transparent;
            border: none;
            flex-shrink: 0; 
        }

        /* ì—ë””í„° í˜ì´ì§€ í‘¸í„° ìŠ¤íƒ€ì¼ (ì•„ì´ì½˜ 4ê°œìš©) */
        .editor-footer { 
            height: 40px; 
            border-top: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: var(--bg-sidebar); 
            padding: 0 10px;
            gap: 4px; 
            flex-shrink: 0;
        }

        /* í‘¸í„° ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (4ê°œ ì•„ì´ì½˜ ëª¨ë‘) */
        .footer-icon-btn { 
            width: 36px;
            height: 36px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0; 
            
            background: none; 
            color: var(--text-mute); 
            border-radius: 6px;
            border: none; 
            transition: 0.2s;
            cursor: pointer;
            flex-shrink: 0;
        }
        .footer-icon-btn:hover { 
            background: var(--active-bg); /* í˜¸ë²„ ì‹œ ë°ì€ íšŒìƒ‰ ë°°ê²½ */
            color: var(--text-main); /* í˜¸ë²„ ì‹œ ì§™ì€ íšŒìƒ‰ ì•„ì´ì½˜ */
        }
        
        /* ğŸ”¥ í™œì„±í™”ëœ ë²„íŠ¼ (ëª¨ë°”ì¼ ë·°, íƒ€ìê¸° ëª¨ë“œ, í°íŠ¸, í…Œë§ˆ ëª¨ë‘) */
        .footer-icon-btn.active {
             background: var(--active-bg); /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
             color: var(--active-color); /* ì§™ì€ íšŒìƒ‰ ì•„ì´ì½˜ */
        }
        .footer-icon-btn.active:hover {
             background: var(--active-bg);
             color: var(--active-color);
             opacity: 0.8;
        }
        
        /* --- ë‹¤í¬ ëª¨ë“œ í™œì„±í™” ì‹œ (ì§™ì€ ë°°ê²½/ë°ì€ ì•„ì´ì½˜ ìœ ì§€) --- */
        :root[data-theme="dark"] .footer-icon-btn.active {
            /* ë‹¤í¬ ëª¨ë“œì˜ --active-bg: ZINC-700 (#3F3F46) */
            background: var(--active-bg); 
            /* ë‹¤í¬ ëª¨ë“œì˜ --text-main: #FAFAFA (í°ìƒ‰) */
            color: var(--text-main); 
        }
        :root[data-theme="dark"] .footer-icon-btn.active:hover {
            background: var(--active-bg); 
            color: var(--text-main); 
            opacity: 0.9;
        }
        /* -------------------------------------------------------------------------------- */


        .footer-icon-btn i {
            font-size: 20px;
        }
        
        .footer-btn { 
            background: none; border: none; cursor: pointer; 
            width: 40px; height: 32px; border-radius: 6px; 
            color: var(--text-mute); 
        }
        .footer-btn:hover { background: var(--bg-app); color: var(--text-main); }


        .tree-list { list-style: none; padding-left: 20px; }
        .tree-list.root { padding-left: 0; }
        .node-row { display: flex; align-items: center; padding: 6px 16px; cursor: pointer; color: var(--text-mute); border-left: 3px solid transparent; }
        .node-row:hover { background: var(--accent-bg); color: var(--text-main); }
        .node-row.active { background: var(--accent-bg); color: var(--accent); font-weight: 600; border-left-color: var(--accent); }
        .node-input { width: 100%; background: var(--bg-app); border: 1px solid var(--accent); color: var(--text-main); padding: 2px 4px; }
        .node-actions { display: none; margin-left: auto; gap: 4px; }
        .node-row:hover .node-actions { display: flex; }

        /* --- Main Content & Editor --- */
        main { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        .toolbar { 
            height: 50px; flex-shrink: 0; background: var(--bg-app); 
            border-bottom: 1px solid var(--border); padding: 0 20px; 
            display: flex; align-items: center; justify-content: space-between; 
            z-index: 60; 
        }
        
        /* íˆ´ë°” í™ˆ ë²„íŠ¼ ì‚­ì œ */
        .toolbar-home-btn { display: none; }
        
        .toolbar-left-group {
            display: flex; align-items: center; gap: 12px; overflow: hidden;
        }
        .breadcrumb { display: flex; align-items: center; gap: 6px; font-size: 14px; color: var(--text-mute); overflow: hidden; white-space: nowrap; }
        .crumb-item { cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
        .crumb-item:hover { color: var(--accent); background: var(--accent-bg); }
        .crumb-divider { opacity: 0.4; }
        .crumb-current { font-weight: 800; color: var(--text-main); cursor: default; pointer-events: none; }
        .workspace { flex: 1; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; padding-bottom: 0; position: relative; }
        
        /* ğŸŒŸ ì¼ë°˜ ëª¨ë“œ í•˜ë‹¨ íŒ¨ë”©ì„ 50vhë¡œ ëŠ˜ë ¤ ì—¬ìœ  ê³µê°„ í™•ë³´ (ì´ì „ ìˆ˜ì • ìœ ì§€) */
        .paper-wrapper { 
            width: 100%; max-width: 800px; 
            padding: 40px 0 50vh; 
            display: flex; justify-content: center; transition: padding-bottom 0.3s; 
            position: relative; z-index: 5; 
        }
        .paper-wrapper.typewriter { padding-bottom: 150vh; }
        
        .paper { width: 100%; background: var(--bg-paper); border: 1px solid var(--border); padding: 60px 80px; min-height: 30vh; height: fit-content; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; }
        .paper.mobile { max-width: 480px; padding: 40px 24px; }
        textarea.editor { 
            width: 100%; min-height: 600px; border: none; resize: none; overflow: hidden; background: transparent; 
            font-family: inherit; 
            font-size: 18px; line-height: 1.8; color: var(--text-main); display: block; padding: 0; margin: 0; position: relative; z-index: 2; 
        }
        #caret-mirror { 
            position: absolute; top: -9999px; left: -9999px; visibility: hidden; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; 
            font-family: inherit; 
            font-size: 18px; line-height: 1.8; padding: 60px 80px; width: 800px; 
        }
        #caret-mirror.mobile { width: 480px; padding: 40px 24px; }
        .typewriter-overlay { position: fixed; bottom: 0; left: 50%; transform: translateX(calc(-50% + var(--sidebar-offset, 0px))); pointer-events: none; z-index: 20; display: block; opacity: 1; transition: filter 0.3s, opacity 0.3s, width 0.3s, margin-bottom 0.3s; width: 947px; margin-bottom: 70px; }
        [data-theme="dark"] .typewriter-overlay { filter: invert(1) grayscale(1) brightness(0.2); }
        aside.closed ~ main .typewriter-overlay { --sidebar-offset: 0px; }
        aside:not(.closed) ~ main .typewriter-overlay { --sidebar-offset: 130px; }
        @media (max-width: 768px) { aside:not(.closed) ~ main .typewriter-overlay { display: none; } }
        .corkboard { width: 100%; padding: 40px; display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 24px; align-content: flex-start; }
        .postit { background: var(--postit-bg); color: var(--postit-text); border: 1px solid var(--postit-border); height: 420px; display: flex; flex-direction: column; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: 0.2s; }
        .postit:hover { transform: translateY(-4px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); z-index: 2; }
        .postit-head { padding: 12px 16px; font-weight: 700; border-bottom: 1px dashed rgba(0,0,0,0.1); cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .postit-body { flex: 1; padding: 8px; }
        .postit-textarea { 
            width: 100%; height: 100%; resize: none; border: none; background: transparent; 
            font-family: inherit; 
            font-size: 14px; line-height: 1.6; color: inherit; 
        }
        .status-bar { position: absolute; bottom: 0; right: 0; background: var(--bg-sidebar); border-top: 1px solid var(--border); border-left: 1px solid var(--border); padding: 8px 16px; font-size: 12px; color: var(--text-mute); cursor: pointer; z-index: 60; }
        .status-bar:hover { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* --- Modal/Alert Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 999; display: flex; align-items: center; justify-content: center; }
        .modal-box { background: var(--bg-modal); width: 320px; padding: 24px; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-radius: 8px; }
        .modal-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 15px; }
        .modal-divider { height: 1px; background: var(--border); margin: 16px 0; }
        .modal-input { 
            width: 80px; text-align: right; background: var(--bg-app); border: 1px solid var(--border); color: var(--text-main); padding: 2px 4px; border-radius: 4px; 
            font-family: inherit; 
        }
        
        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ì„ í•˜ë‹¨ ì¤‘ì•™ìœ¼ë¡œ ì´ë™ */
        .toast-alert {
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%) translateY(100%); 
            z-index: 1000;
            background: var(--bg-sidebar);
            padding: 10px 18px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border);
            opacity: 0; 
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast-alert.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0); 
        }
        .alert-icon { font-size: 18px; }
        .alert-success .alert-icon { color: var(--alert-success); }
        .alert-error .alert-icon { color: var(--alert-error); }

        /* General Button Styles */
        .btn { background: none; border: none; cursor: pointer; padding: 6px; color: var(--text-mute); display:flex; border-radius:4px; }
        .btn:hover { color: var(--text-main); background: var(--active-bg); } /* í˜¸ë²„ ìƒ‰ìƒ í†µì¼ */
        .btn.active { color: var(--accent); background: var(--accent-bg); }

        /* Scrollbar styles */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 5px; border: 2px solid var(--bg-app); }
        [data-theme="dark"] ::-webkit-scrollbar-thumb { background: #475569; border-color: #09090B; }
    </style>
</head>
<body :class="{'custom-font-active': isCustomFontActive}">

<div id="caret-mirror"></div>

<div id="app">
    <template v-if="currentView === 'manager'">
        <div class="project-manager">
            <div class="project-header">
                <div class="project-header-top">
                    <h2><i class="ph ph-books" style="font-size: 24px; margin-right: 8px;"></i> í”„ë¡œì íŠ¸ ëª©ë¡</h2>
                    <div class="global-actions">
                        <button class="global-action-icon" @click="exportAllData" title="í˜„ì¬ ì €ì¥ëœ ëª¨ë“  í”„ë¡œì íŠ¸ë¥¼ í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ë°±ì—…í•©ë‹ˆë‹¤.">
                            <i class="ph ph-floppy-disk" style="font-size:20px;"></i>
                        </button>
                        <button class="global-action-icon" @click="triggerImportAll" title="ë°±ì—… íŒŒì¼ì—ì„œ ëª¨ë“  í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì™€ ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì”ë‹ˆë‹¤.">
                            <i class="ph ph-upload-simple" style="font-size:20px;"></i>
                        </button>
                        
                        <button class="global-btn" style="color:var(--accent); border-color:var(--accent);" @click="createProject">
                            <i class="ph ph-plus" style="font-size:18px;"></i> ìƒˆ í”„ë¡œì íŠ¸
                        </button>
                    </div>
                </div>
            </div>
            
            <ul class="project-list">
                <li v-for="proj in projects" :key="proj.id" class="project-item" :class="{ 'editing-mode': editingProjectId === proj.id }">
                    <div class="project-item-info" @click="editingProjectId !== proj.id && loadProject(proj.id)">
                        <div v-if="editingProjectId === proj.id" style="width: 100%;">
                            <input 
                                type="text" 
                                v-model="proj.title" 
                                class="project-item-input" 
                                @blur="endEditProject"
                                @keydown.enter="endEditProject"
                                @click.stop 
                                v-focus
                            />
                        </div>
                        <template v-else>
                            <div class="project-item-title">
                                {{ proj.title }}
                            </div>
                            <div class="project-item-date">ìµœê·¼ ì €ì¥: {{ formatDate(proj.updatedAt) }}</div>
                        </template>
                    </div>
                    
                    <div class="project-actions">
                        <button class="btn" @click.stop="startEditProject(proj.id)" title="ì´ë¦„ ìˆ˜ì •">
                            <i class="ph ph-pencil" style="font-size:20px;"></i>
                        </button>
                        <button class="btn" @click.stop="deleteProject(proj.id)" title="í”„ë¡œì íŠ¸ ì‚­ì œ" style="color:#EF4444;">
                            <i class="ph ph-trash" style="font-size:20px;"></i>
                        </button>
                    </div>
                </li>
            </ul>
            <div v-if="Object.keys(projects).length === 0" style="margin-top:20px; color:var(--text-mute);">
                ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•´ ë³´ì„¸ìš”!
            </div>
            
            <div class="manager-footer">
                Copyright by ìŠ¤ìœ„ìŠ¤ë²„í„°
            </div>
        </div>
    </template>
    
    <template v-else-if="currentView === 'editor' && currentProject">
        <aside :class="{ closed: !sidebarOpen }">
            <div class="side-head">
                <span style="font-weight:800; letter-spacing:-0.5px;">{{ currentProject.title }}</span>
                
                <div style="display:flex; gap:4px;">
                    <button class="btn" @click="addNode('folder')" title="ìƒˆ í´ë”"><i class="ph ph-folder-plus" style="font-size:18px;"></i></button>
                    <button class="btn" @click="addNode('chapter')" title="ìƒˆ ì±•í„°"><i class="ph ph-file-plus" style="font-size:18px;"></i></button>
                </div>
            </div>

            <div class="tree-container">
                <sortable-tree :items="rootNodes" :all-nodes="currentProject.nodes" parent-id="root" class="root" @item-drop="onDrop"></sortable-tree>
            </div>

            <div class="editor-footer">
                <button class="footer-icon-btn" @click="handleEditorExit" title="í”„ë¡œì íŠ¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°">
                    <i class="ph ph-house-line"></i> 
                </button>
                 <button class="footer-icon-btn" :class="{active: mobileView}" @click="toggleMobile" title="ëª¨ë°”ì¼ ë·°">
                    <i class="ph ph-device-mobile"></i>
                </button>
                <button class="footer-icon-btn" :class="{active: typewriterMode}" @click="toggleTypewriter" title="íƒ€ìê¸° ëª¨ë“œ (í¬ì»¤ìŠ¤)">
                    <i class="ph ph-crosshair"></i>
                </button>
                <button class="footer-icon-btn" :class="{active: isCustomFontActive}" @click="toggleRidibatangFont" title="ê¸€ê¼´ í† ê¸€ (ë¦¬ë””ë°”íƒ•)">
                    <i class="ph ph-text-aa"></i>
                </button>
                <button class="footer-icon-btn" :class="{active: theme === 'dark'}" @click="toggleTheme" title="í…Œë§ˆ ë³€ê²½">
                    <i class="ph" :class="theme==='dark' ? 'ph-moon' : 'ph-sun'"></i>
                </button>
            </div>
        </aside>

        <main>
            <div class="toolbar">
                <div class="toolbar-left-group">
                    <button class="btn" @click="sidebarOpen = !sidebarOpen"><i class="ph" :class="sidebarOpen ? 'ph-caret-left' : 'ph-list'" style="font-size:20px;"></i></button>
                    
                    <div class="breadcrumb">
                        <template v-for="(item, index) in breadcrumbs" :key="index">
                            <span v-if="index > 0" class="crumb-divider"><i class="ph ph-caret-right"></i></span>
                            <div class="crumb-item" @click="selectNode(item.id)">
                                <i v-if="item.type === 'folder'" class="ph ph-folder crumb-icon"></i>
                                <i v-else class="ph ph-file-text" style="font-size:16px;"></i>
                                <span class="crumb-text" :class="{'crumb-current': index === breadcrumbs.length - 1}">
                                    {{ item.title }}
                                </span>
                            </div>
                        </template>
                    </div>
                </div>
                
                </div>

            <div class="workspace" id="workspace-el" @click="focusEditor">
                
                <transition name="fade">
                    <img v-if="typewriterMode && mobileView && activeNode && activeNode.type === 'chapter'" 
                         src="./download.png" 
                         alt="Typewriter" 
                         class="typewriter-overlay"
                         onerror="this.style.display='none'"> 
                </transition>

                <div v-if="activeNode && activeNode.type === 'chapter'" class="paper-wrapper" :class="{typewriter: typewriterMode}">
                    <div class="paper" :class="{mobile: mobileView}">
                        <textarea 
                            class="editor" 
                            v-model="activeNode.content" 
                            placeholder="ì´ê³³ì— ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”..." 
                            ref="editorRef" 
                            @input="handleInput"
                            @click="handleNav"
                            @keyup="handleNav"
                            spellcheck="false"
                        ></textarea>
                    </div>
                </div>

                <div v-else-if="activeNode && activeNode.type === 'folder'" class="corkboard">
                    <div v-for="child in activeChildren" :key="child.id" class="postit">
                        <div class="postit-head" @click.stop="selectNode(child.id)" title="ì—ë””í„°ë¡œ ì´ë™">
                            <i class="ph" :class="child.type==='folder'?'ph-folder':'ph-file-text'"></i> {{ child.title }}
                        </div>
                        <div class="postit-body">
                            <textarea class="postit-textarea" v-model="child.synopsis" @input="handleInput"></textarea>
                        </div>
                    </div>
                    <div v-if="activeChildren.length === 0" style="grid-column:1/-1; text-align:center; color:var(--text-mute);">ë¹„ì–´ìˆëŠ” í´ë”ì…ë‹ˆë‹¤.</div>
                </div>

                <div v-else style="align-self:center; color:var(--text-mute);">ì±•í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
            </div>
            
            <div v-if="activeNode && activeNode.type === 'chapter'" class="status-bar" @click="showStats = true">
                {{ stats.total }}ì ({{ stats.percent }}%)
            </div>
        </main>
    </template>

    <div v-if="showStats" class="modal-overlay" @click="showStats = false">
        <div class="modal-box" @click.stop>
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:bold; font-size:16px;">
                <span>ë¬¸ì„œ í†µê³„</span><i class="ph ph-x" style="cursor:pointer" @click="showStats=false"></i>
            </div>
            <div class="modal-row"><span style="color:var(--text-mute)">ê³µë°± í¬í•¨</span><strong>{{ stats.total }} ì</strong></div>
            <div class="modal-row"><span style="color:var(--text-mute)">ê³µë°± ì œì™¸</span><strong>{{ stats.noSpace }} ì</strong></div>
            <div class="modal-row"><span style="color:var(--text-mute)">ë‹¨ì–´ ìˆ˜</span><strong>{{ stats.words }} ë‹¨ì–´</strong></div>
            <div class="modal-divider"></div>
            <div class="modal-row" style="align-items:center;">
                <span style="color:var(--text-mute)">ëª©í‘œì¹˜</span>
                <input type="number" v-model="targetGoal" class="modal-input" @change="saveConfig">
            </div>
            <div class="modal-row"><span style="color:var(--text-mute)">ì„±ì·¨ìœ¨</span><strong style="color:var(--accent)">{{ stats.percent }}%</strong></div>
        </div>
    </div>
    
    <div v-if="showAlert" class="toast-alert" :class="[alertType, { 'show': showAlert }]">
        <i class="ph alert-icon" :class="alertType === 'alert-success' ? 'ph-check-circle' : 'ph-x-circle'"></i>
        <span>{{ alertMessage }}</span>
    </div>
    
    <input type="file" ref="fileInput" @change="handleImportAll" style="display:none" accept=".vel, .txt">
</div>

<script>
    const { createApp, ref, computed, nextTick, onMounted, watch } = Vue;

    // --- Utility Functions ---
    const utf8_to_b64 = (str) => {
        try { return btoa(unescape(encodeURIComponent(str))); } 
        catch (e) { return btoa(str); }
    };
    const b64_to_utf8 = (str) => {
        try { return decodeURIComponent(escape(atob(str))); } 
        catch (e) { return atob(str); }
    };
    const formatDate = (dateString) => {
        if (!dateString) return 'ì•Œ ìˆ˜ ì—†ìŒ';
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }) + ' ' +
               date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    };
    // --- End Utility Functions ---
    
    // Custom directive to focus the input field
    const vFocus = { mounted: (el) => el.focus() };

    // --- Component Definitions ---
    const NodeRow = {
        name: 'NodeRow', props: ['node'],
        template: `
            <div class="node-row" :class="{ active: $root.activeId === node.id }" @click.stop="$root.selectNode(node.id)" @dblclick.stop="$root.startEdit(node.id)">
                <span style="width:20px; display:flex; justify-content:center;" @click.stop="$root.toggleNode(node.id)">
                    <i class="ph" v-if="node.type==='folder'" :class="node.closed ? 'ph-caret-right' : 'ph-caret-down'" style="font-size:12px; opacity:0.7;"></i>
                </span>
                <i class="ph" :class="node.type==='folder' ? (node.closed?'ph-folder':'ph-folder-open') : 'ph-file-text'" :style="{color: node.type==='folder'?'#F59E0B':'inherit'}" style="font-size:18px; margin-right:8px;"></i>
                <div v-if="$root.editingId !== node.id" style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ node.title }}</div>
                <input v-else v-model="node.title" class="node-input" @blur="$root.endEdit" @keydown.enter="$root.endEdit" @click.stop v-focus>
                <div class="node-actions" v-if="$root.editingId !== node.id"><i class="ph ph-trash" @click.stop="$root.deleteNode(node.id)" style="padding:4px; cursor:pointer;" title="ì‚­ì œ"></i></div>
            </div>
        `, directives: { focus: vFocus }
    };

    const SortableTree = {
        name: 'SortableTree', components: { NodeRow }, props: ['items', 'allNodes', 'parentId'], emits: ['item-drop'],
        setup(props, { emit }) {
            const listRef = ref(null);
            onMounted(() => {
                if(listRef.value) new Sortable(listRef.value, { 
                    group: 'nested', animation: 150, fallbackOnBody: true, swapThreshold: 0.65, 
                    onEnd: (evt) => {
                        const itemId = evt.item.dataset.id; 
                        const newParentId = evt.to.dataset.pid === 'root' ? null : evt.to.dataset.pid; 
                        emit('item-drop', { itemId, newParentId, newIndex: evt.newIndex });
                    }
                });
            });
            return { listRef };
        },
        template: `<ul ref="listRef" :data-pid="parentId" class="tree-list"><li v-for="node in items" :key="node.id" :data-id="node.id"><node-row :node="node"></node-row><sortable-tree v-if="node.type === 'folder' && !node.closed" :items="allNodes.filter(n => n.parent === node.id)" :all-nodes="allNodes" :parent-id="node.id" @item-drop="$emit('item-drop', $event)"></sortable-tree></li></ul>`
    };
    // --- End Component Definitions ---

    const app = createApp({
        components: { SortableTree },
        directives: { focus: vFocus },
        setup() {
            // --- State Management ---
            const currentView = ref('manager'); 
            const projects = ref({}); 
            const currentProjectId = ref(null);
            const editingProjectId = ref(null); 

            // Editor States
            const activeId = ref(null); 
            const editingId = ref(null);
            const sidebarOpen = ref(true); 
            const theme = ref('light'); 
            const mobileView = ref(false);
            const editorRef = ref(null); 
            const fileInput = ref(null);
            const showStats = ref(false); 
            const targetGoal = ref(5000);
            const typewriterMode = ref(false);
            
            // ì‹ ê·œ ìƒíƒœ: í°íŠ¸ í™œì„±í™” ì—¬ë¶€
            const isCustomFontActive = ref(false);
            
            // Alert Modal States
            const showAlert = ref(false);
            const alertMessage = ref('');
            const alertType = ref('alert-success');

            // --- Computed Properties ---
            const currentProject = computed(() => currentProjectId.value ? projects.value[currentProjectId.value] : null);
            const rootNodes = computed(() => currentProject.value ? currentProject.value.nodes.filter(n => !n.parent) : []);
            const activeNode = computed(() => currentProject.value ? currentProject.value.nodes.find(n => n.id === activeId.value) : null);
            
            // ğŸ”¥ ìµœì í™”: ë…¸ë“œ IDë¥¼ í‚¤ë¡œ í•˜ëŠ” ë§µ ìƒì„± (O(1) ê²€ìƒ‰ì„ ìœ„í•´)
            const nodeMap = computed(() => {
                const map = {};
                if (currentProject.value) {
                    currentProject.value.nodes.forEach(node => {
                        map[node.id] = node;
                    });
                }
                return map;
            });

            // ğŸ”¥ ìµœì í™”ëœ breadcrumbs ê³„ì‚° ë¡œì§
            const breadcrumbs = computed(() => {
                if (!activeNode.value || !currentProject.value) return [];
                let path = [];
                let curr = activeNode.value;
                while(curr) {
                    path.unshift({ id: curr.id, title: curr.title, type: curr.type });
                    if(!curr.parent) break;
                    curr = nodeMap.value[curr.parent]; // O(1) ê²€ìƒ‰
                }
                return path;
            });
            
            // ğŸ”¥ ìµœì í™”: í´ë” ë·°ë¥¼ ìœ„í•œ ìì‹ ë…¸ë“œ ëª©ë¡ ìºì‹±
            const activeChildren = computed(() => {
                if (activeNode.value && activeNode.value.type === 'folder') {
                    return currentProject.value.nodes.filter(n => n.parent === activeNode.value.id);
                }
                return [];
            });


            const stats = computed(() => {
                const txt = activeNode.value?.content || '';
                const total = txt.length;
                const percent = targetGoal.value > 0 ? Math.floor((total / targetGoal.value) * 100) : 100;
                return { total, noSpace: txt.replace(/\s/g, '').length, words: txt.trim()?txt.trim().split(/\s+/).length:0, percent };
            });
            
            // --- Alert Logic (Toast Style) ---
            const showInternalAlert = (message, type = 'success') => {
                clearTimeout(window._at);
                alertMessage.value = message;
                alertType.value = type === 'success' ? 'alert-success' : 'alert-error';
                showAlert.value = true;
                
                nextTick(() => {
                    const toast = document.querySelector('.toast-alert');
                    if (toast) toast.classList.add('show');
                });
                
                window._at = setTimeout(() => {
                    const toast = document.querySelector('.toast-alert');
                    if (toast) toast.classList.remove('show');
                    
                    setTimeout(() => {
                        showAlert.value = false;
                    }, 300); 
                }, 3000);
            };

            // --- Data Management (Core) ---
            const PROJECT_KEY = 'ns318_projects';
            const CONFIG_KEY = 'ns318_global_cfg';

            
            // í°íŠ¸ í´ë˜ìŠ¤ ì ìš© ë¡œì§
            const applyFontClass = () => {
                const body = document.body;
                if (isCustomFontActive.value) {
                    body.classList.add('custom-font-active');
                } else {
                    body.classList.remove('custom-font-active');
                }
            };

            const loadAllData = () => {
                const p = localStorage.getItem(PROJECT_KEY); 
                if(p) projects.value = JSON.parse(p);
                
                const c = localStorage.getItem(CONFIG_KEY);
                if(c) { 
                    const cfg = JSON.parse(c); 
                    theme.value = cfg.theme || 'light'; 
                    // í°íŠ¸ ìƒíƒœ ë¡œë“œ ë° ì ìš©
                    isCustomFontActive.value = cfg.isCustomFontActive || false;
                }
                applyTheme();
                applyFontClass(); 
            };

            const saveData = () => { 
                if (currentProjectId.value) {
                    projects.value[currentProjectId.value].updatedAt = new Date().toISOString();
                }
                localStorage.setItem(PROJECT_KEY, JSON.stringify(projects.value)); 
            };
            
            // ì „ì—­ ì„¤ì •ì„ ì €ì¥í•  ë•Œ í°íŠ¸ ìƒíƒœë„ í•¨ê»˜ ì €ì¥
            const saveConfig = () => { 
                localStorage.setItem(CONFIG_KEY, JSON.stringify({ 
                    theme: theme.value, 
                    isCustomFontActive: isCustomFontActive.value 
                }));
                if (currentProject.value) {
                     currentProject.value.config = { target: targetGoal.value, typewriter: typewriterMode.value };
                     saveData();
                }
            }; 
            
            // í°íŠ¸ í† ê¸€ ê¸°ëŠ¥
            const toggleRidibatangFont = () => {
                isCustomFontActive.value = !isCustomFontActive.value;
                applyFontClass();
                saveConfig();
                showInternalAlert(isCustomFontActive.value ? 'ê¸€ê¼´ì´ ë¦¬ë””ë°”íƒ•ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê¸€ê¼´ì´ ì‹œìŠ¤í…œ ê¸°ë³¸ í°íŠ¸ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
            };

            const createProject = () => {
                const title = prompt('ìƒˆ í”„ë¡œì íŠ¸ì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ìƒˆ ì†Œì„¤ í”„ë¡œì íŠ¸');
                if (title) {
                    const newId = Date.now().toString(36);
                    projects.value[newId] = {
                        id: newId,
                        title: title,
                        updatedAt: new Date().toISOString(),
                        // ì´ˆê¸° êµ¬ì¡°
                        nodes: [
                            { id: 'f1', type: 'folder', title: 'ì„¤ì •ì§‘', parent: null, closed: false, content: '', synopsis: 'ì„¸ê³„ê´€, ìºë¦­í„° ë“± ì†Œì„¤ ë°°ê²½ ì„¤ì •ì„ ì €ì¥í•˜ëŠ” ê³µê°„ì…ë‹ˆë‹¤.' },
                            { id: 'c1', type: 'chapter', title: 'ì„¸ê³„ê´€', parent: 'f1', content: '# ì„¸ê³„ê´€ ì„¤ì •\n\n- ì£¼ìš” ëŒ€ë¥™, ë‚˜ë¼, ë§ˆë²• ì‹œìŠ¤í…œ ë“±ì„ ì •ë¦¬í•˜ì„¸ìš”.', synopsis: 'ì„¸ê³„ê´€ ë° ì£¼ìš” ë°°ê²½ ìš”ì•½' },
                            { id: 'c2', type: 'chapter', title: 'ìºë¦­í„°', parent: 'f1', content: '# ì£¼ìš” ë“±ì¥ì¸ë¬¼\n\n- ì£¼ì¸ê³µ, ì£¼ë³€ ì¸ë¬¼ë“¤ì˜ ì¸ì  ì‚¬í•­, íŠ¹ì§• ë“±ì„ ì •ë¦¬í•˜ì„¸ìš”.', synopsis: 'ì£¼ìš” ë“±ì¥ì¸ë¬¼ ìš”ì•½' },
                            { id: 'f2', type: 'folder', title: 'ë³¸ë¬¸', parent: null, closed: false, content: '', synopsis: 'ì‹¤ì œ ì†Œì„¤ ì›ê³ ë¥¼ ì‘ì„±í•˜ëŠ” í´ë”ì…ë‹ˆë‹¤.' },
                            { id: 'c3', type: 'chapter', title: 'í”„ë¡¤ë¡œê·¸', parent: 'f2', content: '', synopsis: 'í”„ë¡¤ë¡œê·¸ ìš”ì•½' },
                            { id: 'c4', type: 'chapter', title: 'ì œ 1í™”', parent: 'f2', content: '', synopsis: '1í™” ë‚´ìš© ìš”ì•½' },
                            { id: 'c5', type: 'chapter', title: 'ì œ 2í™”', parent: 'f2', content: '', synopsis: '2í™” ë‚´ìš© ìš”ì•½' },
                            { id: 'c6', type: 'chapter', title: 'ë©”ëª¨', parent: null, content: '', synopsis: '' }
                        ],
                        config: { target: 5000, typewriter: false }
                    };
                    saveData();
                    // ì²« ì±•í„°ì¸ 'ì„¸ê³„ê´€'ìœ¼ë¡œ ì´ë™
                    loadProject(newId, 'c1');
                    showInternalAlert(`'${title}' í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            };
            
            const deleteProject = (id) => {
                 if(confirm(`ì •ë§ë¡œ í”„ë¡œì íŠ¸ "${projects.value[id].title}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)`)) {
                    const title = projects.value[id].title;
                    delete projects.value[id];
                    saveData();
                    if (currentProjectId.value === id) {
                        currentProjectId.value = null;
                        currentView.value = 'manager';
                    }
                    showInternalAlert(`'${title}' í”„ë¡œì íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                 }
            };

            const loadProject = (id, defaultNodeId = null) => {
                saveData(); 
                const project = projects.value[id];
                if (!project) return;
                currentProjectId.value = id;
                
                // defaultNodeIdê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì±•í„°ë¥¼ ì°¾ê±°ë‚˜ ë…¸ë“œ 0ì„ ì‚¬ìš©
                let initialActiveId = defaultNodeId || (project.nodes.length > 0 ? project.nodes.find(n=>n.type==='chapter')?.id || project.nodes[0].id : null);
                activeId.value = initialActiveId;

                targetGoal.value = project.config.target || 5000;
                typewriterMode.value = project.config.typewriter || false;
                currentView.value = 'editor';
                nextTick(() => { autoResize(); updateTypewriter(false); });
            };
            
            const handleEditorExit = () => {
                saveData(); 
                showInternalAlert(`'${currentProject.value?.title || 'í˜„ì¬ í”„ë¡œì íŠ¸'}'ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                currentView.value = 'manager';
            };

            const startEditProject = (id) => {
                 currentProjectId.value = null; 
                 editingProjectId.value = id;
            };
            const endEditProject = () => {
                if (editingProjectId.value) {
                    if (!projects.value[editingProjectId.value].title.trim()) {
                        showInternalAlert('í”„ë¡œì íŠ¸ ì œëª©ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        projects.value[editingProjectId.value].title = 'ì œëª© ì—†ìŒ';
                    } else {
                         showInternalAlert(`'${projects.value[editingProjectId.value].title}'ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                    saveData();
                    editingProjectId.value = null;
                }
            };
            
            // --- Export/Import Logic ---

            const exportAllData = async () => {
                saveData(); 
                const allData = { 
                    version: "3.27_Full", 
                    timestamp: new Date().toISOString(), 
                    projects: projects.value,
                    globalConfig: { theme: theme.value, isCustomFontActive: isCustomFontActive.value } // ì„¤ì •ì— í°íŠ¸ ìƒíƒœ í¬í•¨
                };
                const rawJson = JSON.stringify(allData);
                const encodedData = utf8_to_b64(rawJson); 
                const blob = new Blob([encodedData], {type: 'text/plain;charset=utf-8'});

                const defaultFileName = `Story_Projects_${new Date()}.vel`;
                
                try {
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = defaultFileName; a.click();
                    showInternalAlert(`ì „ì²´ í”„ë¡œì íŠ¸ ë°ì´í„°ê°€ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } catch (err) {
                    showInternalAlert('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
                }
            };

            let importMode = 'all'; 
            const triggerImportAll = () => { importMode = 'all'; fileInput.value.click(); };

            const handleImportAll = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = (evt) => {
                    try {
                        const rawContent = evt.target.result; 
                        const rawJson = b64_to_utf8(rawContent); 
                        const data = JSON.parse(rawJson);
                        
                        if (data.projects && data.version === "3.27_Full" && importMode === 'all') {
                            if (confirm(`ì „ì²´ í”„ë¡œì íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ í˜„ì¬ ë¸Œë¼ìš°ì €ì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                                projects.value = data.projects;
                                theme.value = data.globalConfig.theme || 'light';
                                isCustomFontActive.value = data.globalConfig.isCustomFontActive || false; // í°íŠ¸ ìƒíƒœ ë³µì›
                                applyTheme();
                                applyFontClass();
                                saveData(); 
                                showInternalAlert('ì „ì²´ í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
                                currentView.value = 'manager';
                            }
                        } else if (data.nodes && data.title && data.version.includes("3.27")) {
                            const newId = Date.now().toString(36);
                            projects.value[newId] = {
                                id: newId,
                                title: data.title + ' (ë¶ˆëŸ¬ì˜´)',
                                updatedAt: new Date().toISOString(),
                                nodes: data.nodes,
                                config: data.config || { target: 5000, typewriter: false }
                            };
                            saveData();
                            showInternalAlert(`í”„ë¡œì íŠ¸ '${data.title}' ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!`);
                            currentView.value = 'manager';
                        } else {
                            showInternalAlert('ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. Novel Studio ë°±ì—… íŒŒì¼ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.', 'error');
                        }
                    } catch (err) {
                        console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err);
                        showInternalAlert('íŒŒì¼ì„ ì½ê±°ë‚˜ ë””ì½”ë”©í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                };
                r.readAsText(f); 
                e.target.value = '';
            };


            // --- Editor UI/Utility Logic ---
            
            // ğŸŒŸ updateTypewriter í•¨ìˆ˜ ìµœì¢… ì¬ìˆ˜ì •: ON/OFF ëª¨ë‘ ê°•ì œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ì œì–´í•©ë‹ˆë‹¤.
            const updateTypewriter = (smooth = true) => {
                if(!editorRef.value) return; 
                const ta = editorRef.value;
                const mirror = document.getElementById('caret-mirror');
                const workspace = document.getElementById('workspace-el');
                
                mirror.className = mobileView.value ? 'mobile' : '';
                const subVal = ta.value.substring(0, ta.selectionStart);
                mirror.textContent = subVal;
                const span = document.createElement('span'); span.textContent = '.'; mirror.appendChild(span);
                
                const paddingTop = mobileView.value ? 40 : 60;
                const wrapperTop = 40;
                const cursorY = span.offsetTop + paddingTop + wrapperTop;
                const viewportH = workspace.clientHeight;
                const lineHeight = 18 * 1.8;
                
                // ìŠ¤í¬ë¡¤ í¬ì§€ì…˜ ì¡°ì • ê¸°ì¤€ (í™”ë©´ ìƒë‹¨ì—ì„œ ëª‡ % ì§€ì ì— ì»¤ì„œë¥¼ ë‘˜ì§€)
                // íƒ€ìê¸° ëª¨ë“œ ON: 50% (í™”ë©´ ì¤‘ì•™)
                // íƒ€ìê¸° ëª¨ë“œ OFF: 90% (í™”ë©´ ìƒë‹¨ 90% ì§€ì ì— ì»¤ì„œë¥¼ ë‘  = í•˜ë‹¨ 10% ê³ ì •)
                const scrollAnchorRatio = typewriterMode.value ? 0.6 : 1; 
                
                const viewportAnchor = viewportH * scrollAnchorRatio;
                // ëª©í‘œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜: ì»¤ì„œ ìœ„ì¹˜ - (ë·°í¬íŠ¸ ì•µì»¤ ìœ„ì¹˜) + (ì¤„ ë†’ì´ì˜ ì ˆë°˜)
                const targetScrollY = cursorY - viewportAnchor + (lineHeight / 2);

                workspace.scrollTo({ top: targetScrollY, behavior: smooth ? 'smooth' : 'auto' });
            };


            const autoResize = () => { if(editorRef.value) { editorRef.value.style.height = 'auto'; editorRef.value.style.height = editorRef.value.scrollHeight + 'px'; } };
            const handleInput = () => { autoResize(); updateTypewriter(false); if(window._st) clearTimeout(window._st); window._st = setTimeout(saveData, 1000); };
            const handleNav = () => { updateTypewriter(true); };
            
            // ğŸ”¥ ê²½ê³  í•´ê²°: focusEditor í•¨ìˆ˜ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜
            const focusEditor = () => { 
                if (editorRef.value) {
                    editorRef.value.focus();
                }
            };
            
            watch(activeId, () => nextTick(() => { autoResize(); updateTypewriter(false); }));
            watch(mobileView, () => nextTick(() => updateTypewriter(false)));
            watch(currentProjectId, () => { activeId.value = null; }); 

            const toggleTheme = () => { theme.value = theme.value==='light'?'dark':'light'; applyTheme(); saveConfig(); };
            const applyTheme = () => document.documentElement.setAttribute('data-theme', theme.value);
            const toggleMobile = () => { mobileView.value = !mobileView.value; nextTick(autoResize); };
            const toggleTypewriter = () => { typewriterMode.value = !typewriterMode.value; saveConfig(); nextTick(() => updateTypewriter(true)); };

            const onDrop = ({ itemId, newParentId, newIndex }) => {
                if (!currentProject.value) return;
                const nodes = currentProject.value.nodes;
                const node = nodes.find(n => n.id === itemId); if (!node) return;
                
                nodes.splice(nodes.indexOf(node), 1); node.parent = newParentId;
                const siblings = nodes.filter(n => n.parent === newParentId);
                let insertIdx = nodes.length;
                if (siblings.length > 0) insertIdx = newIndex >= siblings.length ? nodes.indexOf(siblings[siblings.length - 1]) + 1 : nodes.indexOf(siblings[newIndex]);
                nodes.splice(insertIdx, 0, node);
                
                if(newParentId) { const p = nodes.find(n => n.id === newParentId); if(p) p.closed = false; }
                saveData();
            };
            
            onMounted(() => { 
                loadAllData();
                // ğŸ”¥ ìµœì í™”: ë¸Œë¼ìš°ì € ì¢…ë£Œ ì§ì „ ì €ì¥ ë³´ì¥
                window.addEventListener('beforeunload', saveData); 
            });
            
            const selectNode = (id) => { if(!editingId.value) activeId.value = id; };
            const toggleNode = (id) => { const n = currentProject.value.nodes.find(x=>x.id===id); if(n) n.closed=!n.closed; saveData(); };
            const startEdit = (id) => editingId.value = id; 
            const endEdit = () => { 
                if (editingId.value) {
                    const node = currentProject.value.nodes.find(n => n.id === editingId.value);
                    if (node && !node.title.trim()) {
                        showInternalAlert('ë…¸ë“œ ì œëª©ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        node.title = 'ì œëª© ì—†ìŒ'; // ê¸°ë³¸ê°’ ì„¤ì •
                    }
                }
                editingId.value = null; 
                saveData(); 
            };
            const addNode = (type) => { 
                const nodes = currentProject.value.nodes;
                const cur = nodes.find(n => n.id === activeId.value); let parent = cur ? (cur.type==='folder'?cur.id:cur.parent) : null;
                const n = { id: Date.now().toString(36), type, title: type==='folder'?'ìƒˆ í´ë”':'ìƒˆ ì±•í„°', parent, content:'', synopsis: '', closed:false };
                nodes.push(n); if(parent) { const p=nodes.find(x=>x.id===parent); if(p) p.closed = false; }
                activeId.value=n.id; editingId.value=n.id; saveData();
            };
            const deleteNode = (id) => { 
                if(!currentProject.value) return;
                if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í•˜ìœ„ ë…¸ë“œë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) { 
                    const nodes = currentProject.value.nodes;
                    const s = new Set([id]); 
                    const f=(p)=>nodes.filter(x=>x.parent===p).forEach(c=>{s.add(c.id);if(c.type==='folder')f(c.id)}); 
                    f(id); 
                    currentProject.value.nodes=nodes.filter(x=>!s.has(x.id)); 
                    if(s.has(activeId.value)) activeId.value=null; 
                    saveData(); 
                } 
            };
            
            return {
                // Project Management State/Methods
                currentView, projects, currentProject, currentProjectId, editingProjectId,
                loadProject, createProject, deleteProject, exportAllData, triggerImportAll, handleImportAll,
                formatDate, fileInput, startEditProject, endEditProject, handleEditorExit, showInternalAlert,

                // Editor States/Methods
                activeId, editingId, sidebarOpen, theme, mobileView, typewriterMode,
                activeNode, breadcrumbs, stats, showStats, targetGoal,
                editorRef, saveData, handleInput, handleNav, 
                selectNode, toggleNode, startEdit, endEdit, addNode, deleteNode,
                onDrop, toggleTheme, toggleMobile, toggleTypewriter, 
                rootNodes, saveConfig,
                
                // ğŸ”¥ ëª…ì‹œì ìœ¼ë¡œ ë°˜í™˜ëœ focusEditor
                focusEditor,

                // ìµœì í™”ëœ Computed
                activeChildren, // í´ë”ì˜ ìì‹ ë…¸ë“œ ëª©ë¡

                // í°íŠ¸ ê¸°ëŠ¥ ë…¸ì¶œ
                isCustomFontActive, toggleRidibatangFont,
                
                // Alert States
                showAlert, alertMessage, alertType
            };
        }
    });
    
    app.component('sortable-tree', SortableTree); 
    app.mount('#app');
</script>
</body>
</html>
